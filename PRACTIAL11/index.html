<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatter ‚Äî Minimal Social Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020; --panel:#121735; --muted:#93a5fd; --text:#e8eeff; --accent:#6c7cff; --accent-2:#16db65; --danger:#ff5c7a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(120deg,#0b1020,#141a3f);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .sidebar{background:rgba(18,23,53,.7);backdrop-filter: blur(8px);border-right:1px solid rgba(255,255,255,.08);padding:16px;display:flex;flex-direction:column;gap:16px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .logo .dot{width:10px;height:10px;border-radius:50%;background:var(--accent-2);box-shadow:0 0 18px var(--accent-2)}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px}
    .user-card{display:flex;align-items:center;gap:10px;padding:12px}
    .user-card img{width:36px;height:36px;border-radius:50%}
    .btn, button, input, textarea{font-family:inherit}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:var(--text);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.1)}
    .btn.full{width:100%}
    .muted{color:#a8b0d6;font-size:.9rem}
    .search{display:flex;gap:8px;padding:10px}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.2);color:var(--text)}
    .nav{display:flex;flex-direction:column;gap:8px;padding:10px}
    .nav .item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer}
    .nav .item.active,.nav .item:hover{background:rgba(255,255,255,.08)}

    .chats{display:flex;flex-direction:column;gap:6px;padding:8px;overflow:auto}
    .chat-row{display:grid;grid-template-columns:46px 1fr auto;gap:10px;padding:10px;border-radius:12px;cursor:pointer}
    .chat-row:hover{background:rgba(255,255,255,.06)}
    .chat-row img{width:46px;height:46px;border-radius:50%}
    .chat-row .name{font-weight:600}
    .chat-row .last{color:#b7bde3;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .main{display:flex;flex-direction:column;height:100vh}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(18,23,53,.6);backdrop-filter: blur(8px)}
    .topbar .title{display:flex;align-items:center;gap:10px}

    .content{display:grid;grid-template-rows:1fr auto;gap:0;height:calc(100vh - 56px)}
    .messages{padding:14px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:70%;padding:10px 12px;border-radius:14px;line-height:1.35}
    .me{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#8e99ff)}
    .you{align-self:flex-start;background:rgba(255,255,255,.08)}
    .composer{display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.15)}
    .composer textarea{resize:none;height:50px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.2);color:var(--text)}

    .auth{max-width:420px;margin:8vh auto;padding:20px;}
    .auth .group{display:flex;flex-direction:column;gap:6px;margin:8px 0}
    .auth input{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.2);color:var(--text)}
    .switch{margin-top:6px;font-size:.95rem}

    .empty{display:grid;place-items:center;height:100%;color:#aeb7e9}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px dashed rgba(255,255,255,.18)}

    @media(max-width:980px){.app{grid-template-columns:1fr}.sidebar{position:fixed;z-index:10;inset:0 30% 0 0;transform:translateX(-100%);transition:.25s}.sidebar.open{transform:none} .topbar .menu{display:inline-block} .topbar .menu button{font-size:20px} .topbar .title{gap:8px}}
    @media(min-width:981px){.topbar .menu{display:none}}
  </style>
</head>
<body>
<div id="authView" class="auth card" hidden>
  <div class="logo" style="margin-bottom:12px"><span class="dot"></span> <span>Chatter</span></div>
  <h2 id="authTitle">Create account</h2>
  <div class="group"><label>Name</label><input id="nameInput" placeholder="Ada Lovelace"/></div>
  <div class="group"><label>Email</label><input id="emailInput" type="email" placeholder="ada@chatter.app"/></div>
  <div class="group"><label>Password</label><input id="passwordInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
  <div class="group"><button class="btn primary full" id="authSubmit">Sign up</button></div>
  <div class="group"><button class="btn full" id="googleBtn">Continue with Google</button></div>
  <div class="switch" id="authSwitch">Already have an account? <a href="#" id="toLogin">Sign in</a></div>
  <p class="muted" style="margin-top:8px">Fill your Firebase config in the script to run locally.</p>
</div>

<div id="appView" class="app" hidden>
  <aside class="sidebar" id="sidebar">
    <div class="logo"><span class="dot"></span><span>Chatter</span></div>
    <div class="card user-card">
      <img id="meAvatar" src="https://api.dicebear.com/9.x/thumbs/svg?seed=me" alt="me">
      <div>
        <div id="meName" style="font-weight:600">‚Äî</div>
        <div id="meEmail" class="muted">‚Äî</div>
      </div>
    </div>

    <div class="card search">
      <input id="userSearch" placeholder="Search users by name/email"/>
      <button class="btn" id="inviteBtn">+</button>
    </div>

    <div class="nav card">
      <div class="item active" id="navChats">üí¨ Chats</div>
      <div class="item" id="navPeople">üë• People</div>
      <div class="item" id="navProfile">üôç Profile</div>
      <div class="item" id="navLogout">üö™ Logout</div>
    </div>

    <div class="card" style="padding:8px;">
      <div class="muted" style="padding:8px 8px 0">Recent chats</div>
      <div class="chats" id="recentList"></div>
    </div>

    <div class="muted" style="padding:8px;text-align:center">Built with Firebase</div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="title">
        <div class="menu"><button class="btn ghost" id="toggleSidebar">‚ò∞</button></div>
        <div><strong id="chatTitle">Welcome</strong><div id="chatSub" class="muted" style="font-size:.9rem">Select a conversation or find people to start chatting.</div></div>
      </div>
    </div>

    <div class="content">
      <div class="messages" id="messages"></div>
      <div class="composer" id="composer" hidden>
        <textarea id="messageInput" placeholder="Type a message‚Ä¶"></textarea>
        <button class="btn primary" id="sendBtn">Send</button>
      </div>
      <div class="empty" id="emptyState"><div class="pill">No chat selected</div></div>
    </div>
  </main>
</div>

<script type="module">
  // === 1) Fill YOUR Firebase config here ===
const firebaseConfig = {
  apiKey: "AIzaSyAhXt5P4v3QU26Kg864PvGEkVD2UTPbevk",
  authDomain: "pra11-8f38d.firebaseapp.com",
  projectId: "pra11-8f38d",
  storageBucket: "pra11-8f38d.firebasestorage.app",
  messagingSenderId: "453199078375",
  appId: "1:453199078375:web:0979d51222ec59645dd342",
  measurementId: "G-Y2V3P3K0F5"
};

  // === 2) Firebase SDKs (v10 modular) ===
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, getDocs, serverTimestamp, onSnapshot, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  let app, auth, db;
  try {
    console.log('Initializing Firebase with config:', firebaseConfig);
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
    
    // Test Firebase connection
    console.log('Testing Firebase connection...');
    
    console.log('Firebase initialized successfully');
    console.log('Auth object:', auth);
    console.log('DB object:', db);
    
  } catch (error) {
    console.error('Firebase initialization error:', error);
    console.error('Error code:', error.code);
    console.error('Error message:', error.message);
    
    // Show detailed error to user
    let errorMessage = 'Firebase initialization failed: ' + error.message;
    if (error.code === 'auth/invalid-api-key') {
      errorMessage += '\n\nPlease check your Firebase API key in the configuration.';
    } else if (error.code === 'auth/api-key-not-valid') {
      errorMessage += '\n\nYour Firebase API key is not valid. Please check your Firebase project settings.';
    } else if (error.code === 'app/invalid-app-credential') {
      errorMessage += '\n\nInvalid app credentials. Please check your Firebase configuration.';
    }
    
    alert(errorMessage);
  }

  // DOM refs
  const authView = document.getElementById('authView');
  const appView = document.getElementById('appView');
  const authTitle = document.getElementById('authTitle');
  const nameInput = document.getElementById('nameInput');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const authSubmit = document.getElementById('authSubmit');
  const toLogin = document.getElementById('toLogin');
  const googleBtn = document.getElementById('googleBtn');

  const meName = document.getElementById('meName');
  const meEmail = document.getElementById('meEmail');
  const meAvatar = document.getElementById('meAvatar');

  const recentList = document.getElementById('recentList');
  const userSearch = document.getElementById('userSearch');
  const inviteBtn = document.getElementById('inviteBtn');
  const navLogout = document.getElementById('navLogout');
  const navChats = document.getElementById('navChats');
  const navPeople = document.getElementById('navPeople');
  const navProfile = document.getElementById('navProfile');

  const chatTitle = document.getElementById('chatTitle');
  const chatSub = document.getElementById('chatSub');
  const messagesEl = document.getElementById('messages');
  const composer = document.getElementById('composer');
  const emptyState = document.getElementById('emptyState');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const toggleSidebar = document.getElementById('toggleSidebar');
  const sidebar = document.getElementById('sidebar');

  let isSignup = true;
  let activeChatId = null;
  let messagesUnsub = null; // real-time listener cleanup

  const provider = new GoogleAuthProvider();

  function setAuthMode(signup){
    isSignup = signup;
    authTitle.textContent = signup ? 'Create account' : 'Welcome back';
    authSubmit.textContent = signup ? 'Sign up' : 'Sign in';
    nameInput.parentElement.style.display = signup ? 'flex' : 'none';
    document.getElementById('authSwitch').innerHTML = signup ? 'Already have an account? <a href="#" id="toLogin">Sign in</a>' : "Don't have an account? <a href='#' id='toSignup'>Create one'</a>";
    document.getElementById('toLogin')?.addEventListener('click', e=>{e.preventDefault(); setAuthMode(false)});
    document.getElementById('toSignup')?.addEventListener('click', e=>{e.preventDefault(); setAuthMode(true)});
  }

  setAuthMode(true);

  googleBtn.addEventListener('click', async ()=>{
    try{
      console.log('Attempting Google sign-in...');
      const cred = await signInWithPopup(auth, provider);
      console.log('Google sign-in successful:', cred.user.uid);
      await ensureUserDoc(cred.user);
    }catch(e){ 
      console.error('Google sign-in error:', e);
      alert('Google sign-in failed: ' + e.message); 
    }
  });

  authSubmit.addEventListener('click', async ()=>{
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if(!email || !pass){
      alert('Please enter both email and password');
      return;
    }
    try{
      console.log('Attempting authentication...');
      if(isSignup){
        const name = nameInput.value.trim() || email.split('@')[0];
        console.log('Creating user account...');
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        console.log('User created successfully:', cred.user.uid);
        await updateProfile(cred.user, { displayName: name, photoURL: `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(name)}` });
        await ensureUserDoc(cred.user);
      }else{
        console.log('Signing in user...');
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        console.log('User signed in successfully:', cred.user.uid);
        await ensureUserDoc(cred.user);
      }
    }catch(e){ 
      console.error('Authentication error:', e);
      alert('Authentication failed: ' + e.message); 
    }
  });

  navLogout.addEventListener('click', ()=> signOut(auth));
  toggleSidebar.addEventListener('click', ()=> sidebar.classList.toggle('open'));
  
  // Navigation event listeners
  navChats.addEventListener('click', () => showView('chats'));
  navPeople.addEventListener('click', () => showView('people'));
  navProfile.addEventListener('click', () => showView('profile'));

  onAuthStateChanged(auth, async (user)=>{
    console.log('Auth state changed:', user ? 'User logged in' : 'User logged out');
    if(user){
      console.log('User details:', { uid: user.uid, email: user.email, displayName: user.displayName });
      
      // Initialize Firestore collections and create sample users if needed
      try {
        await initializeFirestoreCollections();
        await createSampleUsers();
      } catch (error) {
        console.error('Error during initialization:', error);
      }
      
      authView.hidden = true; appView.hidden = false;
      meName.textContent = user.displayName || 'Anonymous';
      meEmail.textContent = user.email || '';
      meAvatar.src = user.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(user.uid)}`;
      try {
        await loadRecentChats(user.uid);
      } catch (error) {
        console.error('Error loading recent chats:', error);
      }
    }else{
      console.log('No user logged in');
      appView.hidden = true; authView.hidden = false; setAuthMode(false);
    }
  });

  async function ensureUserDoc(user){
    const ref = doc(db, 'users', user.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, { uid:user.uid, name:user.displayName||'Anonymous', email:user.email, photoURL:user.photoURL||'', createdAt: serverTimestamp() });
      console.log('Created user document for:', user.uid);
    }
  }

  // Initialize Firestore collections structure
  async function initializeFirestoreCollections() {
    console.log('Initializing Firestore collections...');
    
    try {
      // Check if users collection exists by trying to read it
      const usersRef = collection(db, 'users');
      const usersSnapshot = await getDocs(usersRef);
      console.log('Users collection exists with', usersSnapshot.size, 'documents');
      
      // Check if chats collection exists
      const chatsRef = collection(db, 'chats');
      const chatsSnapshot = await getDocs(chatsRef);
      console.log('Chats collection exists with', chatsSnapshot.size, 'documents');
      
      // Check if userChats collection exists
      const userChatsRef = collection(db, 'userChats');
      const userChatsSnapshot = await getDocs(userChatsRef);
      console.log('UserChats collection exists with', userChatsSnapshot.size, 'documents');
      
      return true;
    } catch (error) {
      console.error('Error initializing Firestore collections:', error);
      return false;
    }
  }

  // Create sample users for testing (only if no users exist)
 async function createSampleUsers() {
    console.log('Checking if sample users need to be created...');
    
    try {
      const usersRef = collection(db, 'users');
      const snapshot = await getDocs(usersRef);
      
      if (snapshot.size === 0) {
        console.log('No users found, creating sample users...');
        
        // Sample user 1
        await setDoc(doc(usersRef, 'sample_user_1'), {
          uid: 'sample_user_1',
          name: 'Alice Johnson',
          email: 'alice@example.com',
          photoURL: 'https://api.dicebear.com/9.x/thumbs/svg?seed=Alice',
          createdAt: serverTimestamp()
        });
        
        // Sample user 2
        await setDoc(doc(usersRef, 'sample_user_2'), {
          uid: 'sample_user_2',
          name: 'Bob Smith',
          email: 'bob@example.com',
          photoURL: 'https://api.dicebear.com/9.x/thumbs/svg?seed=Bob',
          createdAt: serverTimestamp()
        });
        
        // Sample user 3
        await setDoc(doc(usersRef, 'sample_user_3'), {
          uid: 'sample_user_3',
          name: 'Carol Williams',
          email: 'carol@example.com',
          photoURL: 'https://api.dicebear.com/9.x/thumbs/svg?seed=Carol',
          createdAt: serverTimestamp()
        });
        
        console.log('Sample users created successfully!');
        return true;
      } else {
        console.log('Users already exist, skipping sample creation');
        return false;
      }
    } catch (error) {
      console.error('Error creating sample users:', error);
      return false;
    }
  }

  // Search & people listing
  userSearch.addEventListener('input', debounce(async (e)=>{
    const term = e.target.value.trim().toLowerCase();
    const me = auth.currentUser;
    if(!me) return;
    
    // Only show search results in People view
    if (currentView !== 'people') {
      showView('people');
    }
    
    const usersRef = collection(db, 'users');
    const qs = await getDocs(usersRef);
    const allUsers = qs.docs.map(d=>d.data()).filter(u=>u.uid!==me.uid);
    
    if(term){
      const filteredUsers = allUsers.filter(u=> 
        (u.name||'').toLowerCase().includes(term) || 
        (u.email||'').toLowerCase().includes(term)
      );
      renderPeopleInMain(filteredUsers);
    }else{
      renderPeopleInMain(allUsers.slice(0,50));
    }
  }, 300));

  // Fix invite button to only work when explicitly clicked
  inviteBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    e.stopPropagation();
    const url = location.href;
    location.href = `mailto:?subject=Join me on Chatter&body=Let's chat here: ${url}`;
  });

  function renderPeopleInMain(users){
    console.log('renderPeopleInMain called with', users.length, 'users');
    // Clear the main content area and show people there
    messagesEl.innerHTML = '';
    emptyState.hidden = true;
    composer.hidden = true;
    console.log('Cleared main content area');
    
    if (users.length === 0) {
      messagesEl.innerHTML = '<div style="text-align: center; color: #aeb7e9; padding: 40px;">No users found</div>';
      return;
    }
    
    const container = document.createElement('div');
    container.style.padding = '20px';
    
    users.forEach(u=>{
      const row = document.createElement('div');
      row.className = 'chat-row';
      row.style.cursor = 'pointer';
      row.innerHTML = `
        <img src="${u.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(u.name||u.uid)}`}" alt="pfp">
        <div>
          <div class='name'>${escapeHtml(u.name||'User')}</div>
          <div class='last'>${escapeHtml(u.email||'')}</div>
        </div>
        <div><button class='btn primary'>Chat</button></div>
      `;
      
      // Add click event to the whole row and the button
      const chatButton = row.querySelector('button');
      const startChat = () => startChatWith(u.uid);
      
      row.addEventListener('click', startChat);
      chatButton.addEventListener('click', (e) => {
        e.stopPropagation();
        startChat();
      });
      
      container.appendChild(row);
    });
    
    messagesEl.appendChild(container);
  }

  // Recent chats (userChats subcollection per user for quick listing)
  function loadRecentChats(uid){
    const ucRef = collection(db, 'userChats', uid, 'items');
    const qy = query(ucRef, orderBy('updatedAt','desc'));
    onSnapshot(qy, (qs)=>{
      recentList.innerHTML = '';
      qs.forEach(docu=>{
        const c = docu.data();
        const row = document.createElement('div');
        row.className = 'chat-row';
        row.dataset.chatId = c.chatId;
        row.innerHTML = `
          <img src="${c.otherPhoto || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(c.otherUid)}`}" alt="pfp">
          <div><div class="name">${escapeHtml(c.otherName||'User')}</div><div class="last">${escapeHtml(c.lastMessage||'Say hi üëã')}</div></div>
          <div class="muted">${timeAgo(c.updatedAt?.toDate?.()||new Date())}</div>`;
        row.addEventListener('click', async ()=> {
          try {
            // Get the other user's full info
            const otherUserRef = doc(db, 'users', c.otherUid);
            const otherUserSnap = await getDoc(otherUserRef);
            const otherUserData = otherUserSnap.data();
            
            openChat(c.chatId, {
              uid: c.otherUid, 
              name: c.otherName || otherUserData?.name || 'User', 
              photo: c.otherPhoto || otherUserData?.photoURL,
              email: otherUserData?.email || ''
            });
          } catch (error) {
            console.error('Error opening chat:', error);
            // Fallback to basic info
            openChat(c.chatId, {
              uid: c.otherUid, 
              name: c.otherName || 'User', 
              photo: c.otherPhoto
            });
          }
        });
        recentList.appendChild(row);
      });
    });
  }

  function composeChatId(a,b){ return a < b ? `${a}_${b}` : `${b}_${a}` }

  async function startChatWith(otherUid){
    console.log('Starting chat with user:', otherUid);
    const me = auth.currentUser;
    if(!me || me.uid===otherUid) return;
    
    const chatId = composeChatId(me.uid, otherUid);
    console.log('Chat ID:', chatId);
    
    try {
      const chatRef = doc(db, 'chats', chatId);
      const chatSnap = await getDoc(chatRef);
      if(!chatSnap.exists()){
        console.log('Creating new chat document');
        // Create chat doc
        await setDoc(chatRef, { 
          chatId, 
          participants:[me.uid, otherUid], 
          createdAt: serverTimestamp(), 
          updatedAt: serverTimestamp(), 
          lastMessage:'' 
        });
      }

      // Mirror in each user's userChats for fast recent list
      console.log('Getting user documents...');
      const other = await getDoc(doc(db,'users',otherUid));
      const meUser = await getDoc(doc(db,'users',me.uid));
      
      const otherData = other.data();
      const meUserData = meUser.data();
      
      if (!otherData) {
        console.error('Other user not found:', otherUid);
        alert('User not found');
        return;
      }
      
      console.log('Creating userChats entries...');
      await setDoc(doc(db,'userChats',me.uid,'items',chatId), {
        chatId, otherUid, otherName: otherData.name||'User', otherPhoto: otherData.photoURL||'', lastMessage:'', updatedAt: serverTimestamp()
      }, { merge:true });
      
      await setDoc(doc(db,'userChats',otherUid,'items',chatId), {
        chatId, otherUid: me.uid, otherName: meUserData?.name||'User', otherPhoto: meUserData?.photoURL||'', lastMessage:'', updatedAt: serverTimestamp()
      }, { merge:true });

      console.log('Chat created successfully, opening chat...');
      openChat(chatId, {uid: otherUid, name: otherData.name, photo: otherData.photoURL, email: otherData.email});
      
    } catch (error) {
      console.error('Error starting chat:', error);
      alert('Error starting chat: ' + error.message);
    }
  }

  function openChat(chatId, other){
    activeChatId = chatId;
    chatTitle.textContent = other?.name || 'Chat';
    chatSub.textContent = other?.email || '';
    emptyState.hidden = true; composer.hidden = false; messagesEl.innerHTML = '';
    sidebar.classList.remove('open');

    if(messagesUnsub) messagesUnsub();
    const msgsRef = collection(db,'chats',chatId,'messages');
    const qy = query(msgsRef, orderBy('createdAt','asc'));
    messagesUnsub = onSnapshot(qy, (qs)=>{
      messagesEl.innerHTML = '';
      qs.forEach(d=>{
        const m = d.data();
        const isMe = m.senderId === auth.currentUser?.uid;
        const div = document.createElement('div');
        div.className = `bubble ${isMe? 'me':'you'}`;
        div.textContent = m.text;
        messagesEl.appendChild(div);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  async function sendMessage(){
    const text = messageInput.value.trim();
    if(!text || !activeChatId) return;
    const me = auth.currentUser; if(!me) return;
    messageInput.value = '';
    const msgsRef = collection(db,'chats',activeChatId,'messages');
    await addDoc(msgsRef, { text, senderId: me.uid, createdAt: serverTimestamp() });
    // update last message mirrors
    const chatRef = doc(db,'chats',activeChatId);
    await updateDoc(chatRef, { lastMessage:text, updatedAt: serverTimestamp() });

    // Determine other userId from chatId
    const [a,b] = activeChatId.split('_');
    const otherUid = me.uid===a? b:a;
    await updateDoc(doc(db,'userChats',me.uid,'items',activeChatId), { lastMessage:text, updatedAt: serverTimestamp() });
    await updateDoc(doc(db,'userChats',otherUid,'items',activeChatId), { lastMessage:text, updatedAt: serverTimestamp() });
  }

  // Helpers
  function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms) } }
  function escapeHtml(s){ return s?.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39"}[c])) }
  function timeAgo(date){ const d = (typeof date==='number')? new Date(date):date; const diff = Math.floor((Date.now()-d.getTime())/1000); if(diff<60) return diff+"s"; if(diff<3600) return Math.floor(diff/60)+"m"; if(diff<86400) return Math.floor(diff/3600)+"h"; return Math.floor(diff/86400)+"d" }

  // View management
  let currentView = 'chats';
  
  function showView(view) {
    currentView = view;
    
    // Update navigation active state
    document.querySelectorAll('.nav .item').forEach(item => item.classList.remove('active'));
    
    // Clear recent list for different views
    recentList.innerHTML = '';
    
    switch(view) {
      case 'chats':
        navChats.classList.add('active');
        chatTitle.textContent = 'Welcome';
        chatSub.textContent = 'Select a conversation or find people to start chatting.';
        emptyState.hidden = false;
        emptyState.innerHTML = '<div class="pill">No chat selected</div>';
        composer.hidden = true;
        messagesEl.innerHTML = '';
        if (auth.currentUser) {
          loadRecentChats(auth.currentUser.uid);
        }
        break;
        
      case 'people':
        navPeople.classList.add('active');
        chatTitle.textContent = 'People';
        chatSub.textContent = 'Find and chat with other users.';
        emptyState.hidden = true;
        composer.hidden = true;
        messagesEl.innerHTML = '';
        loadPeopleInMain();
        break;
        
      case 'profile':
        navProfile.classList.add('active');
        chatTitle.textContent = 'Profile';
        chatSub.textContent = 'Your profile information.';
        emptyState.hidden = true;
        composer.hidden = true;
        messagesEl.innerHTML = '';
        loadProfileInMain();
        break;
    }
    
    // Clean up any active chat
    activeChatId = null;
    if (messagesUnsub) {
      messagesUnsub();
      messagesUnsub = null;
    }
  }

  async function loadPeopleInMain() {
    console.log('loadPeopleInMain called');
    const me = auth.currentUser;
    if (!me) {
      console.log('No current user');
      return;
    }
    
    try {
      console.log('Fetching users from Firestore...');
      const usersRef = collection(db, 'users');
      const qs = await getDocs(usersRef);
      const users = qs.docs.map(d => d.data()).filter(u => u.uid !== me.uid);
      console.log('Found users:', users.length, users);
      
      recentList.innerHTML = '<div class="muted" style="padding: 8px 8px 0">Available users</div>';
      
      // Show users in sidebar for quick access
      users.slice(0, 10).forEach(u => {
        const row = document.createElement('div');
        row.className = 'chat-row';
        row.innerHTML = `
          <img src="${u.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(u.name || u.uid)}`}" alt="pfp">
          <div>
            <div class='name'>${escapeHtml(u.name || 'User')}</div>
            <div class='last'>${escapeHtml(u.email || '')}</div>
          </div>
          <div><button class='btn primary'>Chat</button></div>
        `;
        row.querySelector('button').addEventListener('click', () => startChatWith(u.uid));
        recentList.appendChild(row);
      });
      
      // Show all users in main area
      console.log('About to call renderPeopleInMain with', users.length, 'users');
      console.log('renderPeopleInMain function exists:', typeof renderPeopleInMain);
      if (typeof renderPeopleInMain === 'function') {
        renderPeopleInMain(users);
      } else {
        console.error('renderPeopleInMain function not found!');
        messagesEl.innerHTML = '<div style="text-align: center; color: #ff5c7a; padding: 40px;">Error: renderPeopleInMain function not found</div>';
      }
      
      if (users.length === 0) {
        recentList.innerHTML += '<div style="padding: 20px; text-align: center; color: #aeb7e9;">No other users found</div>';
      }
    } catch (error) {
      console.error('Error loading people:', error);
      recentList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ff5c7a;">Error loading users</div>';
      messagesEl.innerHTML = '<div style="text-align: center; color: #ff5c7a; padding: 40px;">Error loading users</div>';
    }
  }

  function loadProfileInMain() {
    const me = auth.currentUser;
    if (!me) return;
    
    // Show basic info in sidebar
    recentList.innerHTML = `
      <div style="padding: 20px; text-align: center;">
        <img src="${me.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(me.uid)}`}" 
             style="width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px;" alt="Profile">
        <div style="font-weight: 600;">${escapeHtml(me.displayName || 'Anonymous')}</div>
        <div style="color: #a8b0d6; font-size: 0.9em;">${escapeHtml(me.email || '')}</div>
      </div>
    `;
    
    // Show detailed profile in main area
    messagesEl.innerHTML = `
      <div style="padding: 40px; max-width: 600px; margin: 0 auto;">
        <div style="text-align: center; margin-bottom: 40px;">
          <img src="${me.photoURL || `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(me.uid)}`}" 
               style="width: 120px; height: 120px; border-radius: 50%; margin-bottom: 20px; border: 3px solid var(--accent);" alt="Profile">
          <h2 style="margin: 20px 0 10px;">${escapeHtml(me.displayName || 'Anonymous')}</h2>
          <p style="color: #a8b0d6; font-size: 1.1em;">${escapeHtml(me.email || '')}</p>
        </div>
        
        <div class="card" style="padding: 30px;">
          <h3 style="margin-top: 0; margin-bottom: 20px; color: var(--accent);">Account Information</h3>
          
          <div style="display: grid; gap: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span style="color: #a8b0d6;">User ID:</span>
              <span style="font-family: monospace; font-size: 0.8em; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px;">${me.uid}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <span style="color: #a8b0d6;">Account created:</span>
              <span style="font-weight: 500;">${new Date(me.metadata.creationTime).toLocaleDateString()} at ${new Date(me.metadata.creationTime).toLocaleTimeString()}</span>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
              <span style="color: #a8b0d6;">Last login:</span>
              <span style="font-weight: 500;">${new Date(me.metadata.lastSignInTime).toLocaleDateString()} at ${new Date(me.metadata.lastSignInTime).toLocaleTimeString()}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }

</script>
</body>
</html>
